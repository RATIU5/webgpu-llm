<SYSTEM>Multisampling (MSAA): Anti-aliasing with multisample render targets</SYSTEM>

# Multisampling (MSAA)

## Overview [Section titled “Overview”](#overview) Multisample Anti-Aliasing (MSAA) reduces jagged edges by sampling each pixel multiple times. WebGPU v1 supports 4x MSAA, where each pixel stores 4 samples that are resolved to a single color. ## Sample Counts [Section titled “Sample Counts”](#sample-counts) | Count | Description | | ----- | ---------------------------------------- | | 1 | No multisampling (default) | | 4 | 4x MSAA (only other option in WebGPU v1) | ## Setup Requirements [Section titled “Setup Requirements”](#setup-requirements) MSAA requires matching configuration across: 1. Multisampled color texture 2. Multisampled depth texture (if used) 3. Render pipeline 4. Render pass with resolve target ## Creating Multisampled Textures [Section titled “Creating Multisampled Textures”](#creating-multisampled-textures) ### Color Texture [Section titled “Color Texture”](#color-texture) 4x MSAA color texture ```javascript const msaaTexture = device.createTexture({ size: [canvas.width, canvas.height], format: navigator.gpu.getPreferredCanvasFormat(), sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); ``` ### Depth Texture [Section titled “Depth Texture”](#depth-texture) 4x MSAA depth texture ```javascript const msaaDepthTexture = device.createTexture({ size: [canvas.width, canvas.height], format: "depth24plus", sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); ``` Matching Sample Counts Color and depth textures must have the same `sampleCount`. Mismatched counts cause validation errors. ## Pipeline Configuration [Section titled “Pipeline Configuration”](#pipeline-configuration) MSAA pipeline ```javascript const pipeline = device.createRenderPipeline({ layout: "auto", // ...vertex and fragment config... multisample: { count: 4, }, depthStencil: { format: "depth24plus", depthWriteEnabled: true, depthCompare: "less", }, }); ``` ## Render Pass Configuration [Section titled “Render Pass Configuration”](#render-pass-configuration) ### With Resolve Target [Section titled “With Resolve Target”](#with-resolve-target) MSAA render pass with resolve ```javascript const renderPass = encoder.beginRenderPass({ colorAttachments: [{ view: msaaTexture.createView(), // Multisampled texture resolveTarget: context.getCurrentTexture().createView(), // Single-sample output loadOp: "clear", storeOp: "store", clearValue: { r: 0, g: 0, b: 0, a: 1 }, }], depthStencilAttachment: { view: msaaDepthTexture.createView(), depthLoadOp: "clear", depthStoreOp: "store", depthClearValue: 1.0, }, }); ``` ### Resolution Process [Section titled “Resolution Process”](#resolution-process) The `resolveTarget` receives the averaged result automatically when the render pass ends. No manual resolve step needed. ## Complete Example [Section titled “Complete Example”](#complete-example) Full MSAA setup ```javascript const format = navigator.gpu.getPreferredCanvasFormat(); // 1. Create multisampled textures const msaaColor = device.createTexture({ size: [canvas.width, canvas.height], format: format, sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); const msaaDepth = device.createTexture({ size: [canvas.width, canvas.height], format: "depth24plus", sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); // 2. Configure pipeline const pipeline = device.createRenderPipeline({ layout: "auto", vertex: { module: shaderModule, entryPoint: "vertexMain" }, fragment: { module: shaderModule, entryPoint: "fragmentMain", targets: [{ format }], }, multisample: { count: 4 }, depthStencil: { format: "depth24plus", depthWriteEnabled: true, depthCompare: "less", }, }); // 3. Render with MSAA function render() { const encoder = device.createCommandEncoder(); const pass = encoder.beginRenderPass({ colorAttachments: [{ view: msaaColor.createView(), resolveTarget: context.getCurrentTexture().createView(), loadOp: "clear", storeOp: "store", }], depthStencilAttachment: { view: msaaDepth.createView(), depthLoadOp: "clear", depthStoreOp: "store", depthClearValue: 1.0, }, }); pass.setPipeline(pipeline); pass.draw(vertexCount); pass.end(); device.queue.submit([encoder.finish()]); } ``` ## Reading Multisampled Textures in Shaders [Section titled “Reading Multisampled Textures in Shaders”](#reading-multisampled-textures-in-shaders) Multisampled textures cannot be sampled normally. Use `textureLoad` with sample index: Reading multisampled texture ```wgsl @group(0) @binding(0) var msaaTex: texture_multisampled_2d<f32>; @fragment fn main(@builtin(position) pos: vec4f) -> @location(0) vec4f { let coord = vec2i(pos.xy); // Read each sample manually var color = vec4f(0.0); color += textureLoad(msaaTex, coord, 0); color += textureLoad(msaaTex, coord, 1); color += textureLoad(msaaTex, coord, 2); color += textureLoad(msaaTex, coord, 3); return color / 4.0; // Average } ``` ### Multisampled Depth [Section titled “Multisampled Depth”](#multisampled-depth) Reading multisampled depth ```wgsl @group(0) @binding(0) var msaaDepth: texture_depth_multisampled_2d; @fragment fn main(@builtin(position) pos: vec4f) -> @location(0) vec4f { let coord = vec2i(pos.xy); let depth = textureLoad(msaaDepth, coord, 0); // Sample 0 return vec4f(depth, depth, depth, 1.0); } ``` No Depth Resolve Target Unlike color attachments, depth attachments don’t support `resolveTarget`. To access resolved depth, manually resolve in a compute or fragment shader. ## Resize Handling [Section titled “Resize Handling”](#resize-handling) Recreate multisampled textures when canvas size changes: Handle resize ```javascript function onResize() { msaaColor.destroy(); msaaDepth.destroy(); msaaColor = device.createTexture({ size: [canvas.width, canvas.height], format: format, sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); msaaDepth = device.createTexture({ size: [canvas.width, canvas.height], format: "depth24plus", sampleCount: 4, usage: GPUTextureUsage.RENDER_ATTACHMENT, }); } ``` ## Performance Considerations [Section titled “Performance Considerations”](#performance-considerations) | Aspect | Impact | | --------- | ---------------------------------------------------- | | Memory | 4x for color, 4x for depth | | Bandwidth | Higher due to sample storage | | Fill rate | Fragment shader runs once per pixel (not per sample) | | Resolve | Automatic, minimal overhead | ## Render Bundles with MSAA [Section titled “Render Bundles with MSAA”](#render-bundles-with-msaa) MSAA render bundle ```javascript const bundleEncoder = device.createRenderBundleEncoder({ colorFormats: [format], sampleCount: 4, depthStencilFormat: "depth24plus", }); // Record commands... const bundle = bundleEncoder.finish(); ``` ## Format Support [Section titled “Format Support”](#format-support) Not all formats support multisampling. Common supported formats: | Format | Multisampling | | ----------------- | ------------------- | | `bgra8unorm` | Yes | | `rgba8unorm` | Yes | | `rgba16float` | Yes | | `depth24plus` | Yes | | `depth32float` | Yes | | `bgra8unorm-srgb` | No (some platforms) |